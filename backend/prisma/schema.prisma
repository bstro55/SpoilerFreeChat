// Prisma Schema for SpoilerFreeChat
// Database: Supabase PostgreSQL
//
// This schema defines six main models:
// - Room: Chat rooms for specific games/events (sportType added in Phase 8)
// - Message: Persisted chat messages
// - Session: User sessions for reconnection support
// - User: Authenticated users with preferences (Phase 7)
// - RecentRoom: Tracks recently visited rooms per user (Phase 7, sportType added Phase 8)
// - Report: User-submitted reports of abusive messages (Phase 3)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")      // Pooler connection for runtime (port 6543)
  directUrl = env("DIRECT_URL")        // Session mode for migrations (port 5432)
}

// Authenticated user account (optional - guests don't have one)
// The id matches Supabase Auth UUID for easy integration
model User {
  id                String       @id // Supabase Auth UUID (not auto-generated)
  email             String?      @unique

  // User preferences (synced across devices)
  preferredNickname String?      // Default nickname for new rooms
  theme             String       @default("system") // "light", "dark", "system"
  notificationSound Boolean      @default(true)

  // Metadata
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  // Relations
  sessions          Session[]
  recentRooms       RecentRoom[]
}

// Tracks recently visited rooms for authenticated users
// Enables "quick rejoin" feature on the join screen
model RecentRoom {
  id        String    @id @default(cuid())
  userId    String
  roomCode  String    // The room's shareable code
  nickname  String    // Nickname used in this room
  sportType String    @default("basketball") // Sport type for display (Phase 8)

  // Denormalized room metadata for display (Phase 11)
  roomName  String?   // Display name at time of visit
  teams     String?   // Teams at time of visit
  gameDate  DateTime? // Game date at time of visit

  visitedAt DateTime  @default(now())

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roomCode]) // One entry per room per user
  @@index([userId, visitedAt]) // For sorting recent rooms by visit time
}

// Represents a chat room for a specific game/event
model Room {
  id             String    @id @default(cuid())
  roomCode       String    @unique  // Shareable room code like "GAME-X7K2"
  sportType      String    @default("basketball") // Sport type: basketball, football, hockey, soccer (Phase 8)

  // Room metadata (Phase 11 - Landing Page Redesign)
  roomName       String?   // Display name like "Super Bowl Watch Party"
  teams          String?   // e.g., "Chiefs vs Eagles"
  gameDate       DateTime? // When the game is scheduled

  createdAt      DateTime  @default(now())
  lastActivityAt DateTime  @default(now()) @updatedAt

  // Relations
  messages       Message[]
  sessions       Session[]

  @@index([lastActivityAt])  // For cleanup queries
}

// Persisted chat messages - survives server restarts
model Message {
  id             String   @id @default(cuid())
  roomId         String
  senderNickname String   // Nickname at time of sending (denormalized for history)
  sessionId      String?  // Optional reference to session (may be expired/deleted)
  content        String   // Message content (pre-sanitized)
  timestamp      DateTime @default(now())

  // Relations
  room           Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  session        Session? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([roomId, timestamp])  // For fetching room history
}

// User sessions for reconnection support
// Allows users to refresh the page and resume their session
model Session {
  id               String    @id @default(cuid())
  roomId           String
  nickname         String

  // Optional link to authenticated user (null for guests)
  userId           String?

  // Game time sync data (nullable until user syncs)
  gameTimeQuarter  Int?
  gameTimeMinutes  Int?
  gameTimeSeconds  Int?
  elapsedSeconds   Int?

  // Session tracking
  createdAt        DateTime  @default(now())
  lastSeenAt       DateTime  @default(now())
  isActive         Boolean   @default(true)

  // Current socket connection (null when disconnected but session still valid)
  currentSocketId  String?

  // Relations
  room             Room      @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user             User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  messages         Message[]

  @@unique([roomId, nickname])  // Prevent duplicate nicknames in same room
  @@index([currentSocketId])     // For looking up session by socket
  @@index([lastSeenAt])          // For session cleanup
  @@index([roomId, isActive])    // For listing active users in room
  @@index([userId])              // For finding user's sessions
}

// User-submitted reports of abusive or inappropriate messages
// Visible in the Supabase dashboard and backend logs
model Report {
  id                    String   @id @default(cuid())
  roomCode              String
  reporterNickname      String
  messageContent        String
  messageSenderNickname String
  createdAt             DateTime @default(now())

  @@index([createdAt]) // For admin review sorted by time
}
